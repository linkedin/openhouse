name: Python Package Release

on:
  push:
    branches:
      - main
    paths:
      - 'integrations/python/**'

permissions:
  contents: write  # For git tagging

jobs:
  test-python:
    name: Test Python Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project sources
        uses: actions/checkout@v6

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Test openhouse.dataloader package
        working-directory: integrations/python/dataloader
        run: make sync verify

  tag-python-release:
    name: Tag Python Release
    runs-on: ubuntu-latest
    needs: test-python
    if: success() && github.ref == 'refs/heads/main' && github.repository == 'linkedin/openhouse'
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout project sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get base version from pyproject.toml
        id: base_version
        working-directory: integrations/python/dataloader
        run: |
          version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "Base version from pyproject.toml: ${version}"

      - name: Bump version and push tag
        uses: anothrNick/github-tag-action@1.69.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          DEFAULT_BUMP: patch
          DRY_RUN: false
          INITIAL_VERSION: ${{ steps.base_version.outputs.version }}
          TAG_CONTEXT: branch
          PRERELEASE: false
          # Use custom tag prefix for Python releases
          TAG_PREFIX: python-

      - name: Get the latest Python tag
        id: get_version
        run: |
          # Get the latest tag with python- prefix
          latest_tag=$(git describe --tags --abbrev=0 --match "python-v*" main 2>/dev/null || echo "python-v0.1.0")
          # Extract version without prefix (python-v0.1.0 -> 0.1.0)
          version=${latest_tag#python-v}
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "Python release version: ${version}"

  discover-python-packages:
    name: Discover Python Packages
    runs-on: ubuntu-latest
    needs: tag-python-release
    outputs:
      packages: ${{ steps.discover.outputs.packages }}
    steps:
      - name: Checkout project sources
        uses: actions/checkout@v6

      - name: Define packages
        id: discover
        run: |
          # Currently only openhouse.dataloader package (more can be added later)
          packages='["integrations/python/dataloader"]'
          echo "packages=${packages}" >> "$GITHUB_OUTPUT"
          echo "Python packages: ${packages}"

  build-python-packages:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: [tag-python-release, discover-python-packages]
    strategy:
      matrix:
        package_dir: ${{ fromJson(needs.discover-python-packages.outputs.packages) }}
    steps:
      - name: Checkout project sources
        uses: actions/checkout@v6

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Update version in pyproject.toml
        working-directory: ${{ matrix.package_dir }}
        run: |
          # Update version in pyproject.toml to match git tag
          sed -i.bak 's/^version = .*/version = "${{ needs.tag-python-release.outputs.version }}"/' pyproject.toml
          rm -f pyproject.toml.bak
          echo "Updated version to ${{ needs.tag-python-release.outputs.version }}"
          cat pyproject.toml | grep "^version"

      - name: Sync dependencies
        working-directory: ${{ matrix.package_dir }}
        run: make sync

      - name: Build package
        working-directory: ${{ matrix.package_dir }}
        run: make build

      - name: Validate package with twine
        working-directory: ${{ matrix.package_dir }}
        run: make validate

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-${{ hashFiles(format('{0}/pyproject.toml', matrix.package_dir)) }}
          path: ${{ matrix.package_dir }}/dist/
          retention-days: 7

  # Publish to PyPI
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [tag-python-release, build-python-packages]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-package-*
          merge-multiple: true
          path: dist/

      - name: List artifacts
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          verbose: true
